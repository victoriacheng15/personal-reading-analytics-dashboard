{{define "content"}}
<main class="analytics-page">
    <section aria-label="Key Metrics">
        <h2  class="section-title">üîë Key Metrics</h2>
        <div class="metrics-grid">
            {{range .KeyMetrics}}
            <article class="metric-card">
                <h3 class="metric-title">{{.Title}}</h3>
                <p class="metric-value">{{.Value}}</p>
            </article>
            {{end}}
        </div>
    </section>

    <section aria-label="Highlights & Badges">
        <h2  class="section-title">üèÜ Highlights</h2>
        <div class="badges-grid">
            {{range .HighlightMetrics}}
            <article class="badge-card">
                <h3 class="badge-title">{{.Title}}</h3>
                <p class="badge-value">{{.Value}}</p>
            </article>
            {{end}}
        </div>
    </section>

    <section aria-label="Sources">
        <h2  class="section-title">üìå Sources</h2>
        <div class="sources-grid">
            {{range .Sources}}
            <article class="source-card">
                <h3>{{.Name}}</h3>
                <div class="source-stats">
                    <div class="stat-line">
                        <span>Total:</span>
                        <strong>{{.Count}}</strong>
                    </div>
                    <div class="stat-line">
                        <span>Read:</span>
                        <strong>{{.Read}} ({{printf "%.1f" .ReadPct}}%)</strong>
                    </div>
                    <div class="stat-line">
                        <span>Unread:</span>
                        <strong>{{.Unread}}</strong>
                    </div>
                    {{if gt .AuthorCount 0}}
                    <div class="stat-line"
                        style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--muted-border); font-size: 0.8rem; opacity: 0.7;">
                        <span>Per author:</span>
                        <strong>{{printf "%.0f" (divideFloat .Count .AuthorCount)}} articles</strong>
                    </div>
                    {{end}}
                </div>
            </article>
            {{end}}
        </div>
    </section>

    <!-- Top N Oldest Unread Articles Section -->
    {{ if .TopOldestUnreadArticles }}
    <section aria-label="Top Oldest Unread Articles">
        <h2  class="section-title">üîù Top 3 Oldest Unread Articles</h2>
        {{if .TopOldestUnreadArticles}}
        <div class="articles-list">
            <table class="articles-table">
                <thead>
                    <tr>
                        <th>Published Date</th>
                        <th>Title</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .TopOldestUnreadArticles}}
                    <tr>
                        <td>{{.Date}}</td>
                        <td>
                            {{if .Link}}
                            <a href="{{.Link}}" target="_blank" rel="noopener noreferrer">{{.Title}}</a>
                            {{else}}
                            {{.Title}}
                            {{end}}
                        </td>
                        <td>{{.Category}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{else}}
        <p class="no-data">No unread articles found.</p>
        {{end}}
    </section>
    {{ end }}

    <section aria-label="Yearly Breakdown">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <h2  class="section-title">üìà Yearly Breakdown</h2>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                <input type="range" id="yearChartRangeSlider" min="5" max="50" value="5" class="range-slider"
                    title="Adjust how many recent years to display">
                <span id="yearChartRangeLabel" class="range-label">Last
                    5 years</span>
            </div> <select id="yearViewToggle"
                style="padding: 0.5rem 1rem; border-radius: 6px; border: 2px solid var(--card1); background: white; color: #2d3748; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                <option value="bar">Bar Chart</option>
                <option value="line">Line Chart</option>
            </select>
        </div>
        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="yearChart"></canvas>
            </div>
        </div>
    </section>

    <section aria-label="Monthly Breakdown">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <h2  class="section-title">üìä Monthly Breakdown</h2>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <select id="sourceFilter"
                    style="padding: 0.5rem 1rem; border-radius: 6px; border: 2px solid var(--card1); background: white; color: #2d3748; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                    <option value="all">All Sources</option>
                    {{range .AllSources}}<option value="{{.}}">{{.}}</option>{{end}}
                </select>
                <select id="monthViewToggle"
                    style="padding: 0.5rem 1rem; border-radius: 6px; border: 2px solid var(--card1); background: white; color: #2d3748; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                    <option value="total">Total Articles</option>
                    <option value="stacked">By Source</option>
                </select>
            </div>
        </div>
        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="monthChart"></canvas>
            </div>
        </div>
    </section>

    <section aria-label="Read/Unread Breakdown">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <h2  class="section-title">üìñ Read/Unread Breakdown</h2>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                <input type="range" id="yearRangeSlider" min="5" max="50" value="5" style="display: none;"
                    class="range-slider" title="Adjust how many recent years to display">
                <span id="yearRangeLabel" style="display: none;" class="range-label">Last 5
                    years</span>
            </div> <select id="readUnreadViewToggle"
                style="padding: 0.5rem 1rem; border-radius: 6px; border: 2px solid var(--card1); background: white; color: #2d3748; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                <option value="byYear">By Year</option>
                <option value="byMonth">By Month</option>
                <option value="bySource">By Source</option>
            </select>
        </div>
        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="readUnreadChart"></canvas>
            </div>
        </div>
    </section>

    {{ if .UnreadByYearJSON }}
    <section aria-label="Unread Articles by Year" id="unreadByYearSection">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <h2  class="section-title">üìÖ Unread Articles by Year</h2>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                <input type="range" id="unreadYearChartRangeSlider" min="5" max="50" value="5" class="range-slider"
                    title="Adjust how many recent years to display">
                <span id="unreadYearChartRangeLabel" class="range-label">Last 5 years</span>
            </div> <select id="unreadYearViewToggle"
                style="padding: 0.5rem 1rem; border-radius: 6px; border: 2px solid var(--card1); background: white; color: #2d3748; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                <option value="bar">Bar Chart</option>
                <option value="line">Line Chart</option>
            </select>
        </div>
        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="unreadByYearChart"></canvas>
            </div>
        </div>
    </section>
    {{ end }}

    {{ if .UnreadArticleAgeDistributionJSON }}
    <section aria-label="Unread Articles Age Distribution" id="unreadArticleAgeDistributionSection">
        <h2  class="section-title">‚è∞ Unread Articles Age Distribution</h2>
        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="ageDistributionChart"></canvas>
            </div>
        </div>
    </section>
    {{ end }}
</main>
{{end}}

{{define "script"}}
<script>
    // Chart data
    const yearChartLabels = {{.YearChartLabels }};
    const yearChartData = {{.YearChartData }};
    const monthChartLabels = {{.MonthChartLabels }};
    const monthChartDatasets = {{.MonthChartDatasets }};
    const monthTotalData = {{.MonthTotalData }};
    const readUnreadByMonthData = {{.ReadUnreadByMonthJSON }};
    const readUnreadBySourceData = {{.ReadUnreadBySourceJSON }};
    const readUnreadByYearData = {{.ReadUnreadByYearJSON }};
    const unreadArticleAgeDistributionData = {{.UnreadArticleAgeDistributionJSON }};
    const unreadByYearData = {{.UnreadByYearJSON }};

    // Helper functions
    const updateLabel = (el, val) => el.textContent = `Last ${val} year${val > 1 ? 's' : ''}`;
    const toggleSlider = (show, slider, label) => {
        slider.style.display = show ? 'block' : 'none';
        label.style.display = show ? 'inline' : 'none';
    };
    const createChartConfig = (type, labels, datasets, options = {}) => ({
        type,
        data: { labels, datasets },
        options: { responsive: true, maintainAspectRatio: false, ...options }
    });

    // Chart instances and state
    let [yearChart, monthChart, readUnreadChart] = [null, null, null];
    let [currentYearViewMode, currentSourceFilter, currentReadUnreadView] = ['bar', 'all', 'byMonth'];

    function updateYearChart(viewMode) {
        if (yearChart) yearChart.destroy();
        const yearRange = parseInt(document.getElementById('yearChartRangeSlider').value);
        const labels = yearChartLabels.slice(0, yearRange);
        const data = yearChartData.slice(0, yearRange);
        const yCtx = document.getElementById('yearChart').getContext('2d');

        const baseConfig = {
            label: 'Articles by Year',
            data,
            borderColor: '#2b6cb0',
            borderWidth: viewMode === 'bar' ? 2 : 3
        };

        const chartConfigs = {
            bar: {
                ...baseConfig,
                backgroundColor: ['#2b6cb0', '#60a5fa', '#3b82f6', '#fb923c', '#f97316', '#93c5fd', '#60a5fa'],
                borderRadius: 8,
                type: 'bar'
            },
            line: {
                ...baseConfig,
                backgroundColor: 'rgba(43, 108, 176, 0.08)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 6,
                pointBackgroundColor: '#2b6cb0',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointHoverRadius: 8,
                type: 'line'
            }
        };

        const config = chartConfigs[viewMode];
        yearChart = new Chart(yCtx, createChartConfig(config.type, labels, [config], {
            plugins: { legend: { display: viewMode === 'line', labels: { font: { size: 12 }, usePointStyle: true } } },
            scales: {
                x: { ticks: { font: { size: 12 } } },
                y: { beginAtZero: true, ticks: { font: { size: 12 } } }
            }
        }));
    }

    // Initialize year chart
    updateYearChart('bar');
    const ySlider = document.getElementById('yearChartRangeSlider'), yLabel = document.getElementById('yearChartRangeLabel');
    ySlider.max = yearChartLabels.length;
    ySlider.value = Math.min(5, yearChartLabels.length);
    updateLabel(yLabel, ySlider.value);
    document.getElementById('yearViewToggle').addEventListener('change', e => {
        currentYearViewMode = e.target.value;
        updateYearChart(currentYearViewMode);
    });
    ySlider.addEventListener('input', e => {
        updateLabel(yLabel, e.target.value);
        updateYearChart(currentYearViewMode);
    });

    function filterMonthData() {
        const filtered = currentSourceFilter === 'all' ? monthChartDatasets :
            [monthChartDatasets.find(d => d.label === currentSourceFilter)].filter(Boolean);
        return { labels: monthChartLabels, totalData: monthTotalData, datasets: filtered };
    }

    function updateMonthChart(view) {
        if (monthChart) monthChart.destroy();
        const { labels, totalData, datasets } = filterMonthData();
        const mCtx = document.getElementById('monthChart').getContext('2d');
        const baseOpts = {
            plugins: { legend: { display: true, labels: { font: { size: 12 }, usePointStyle: true } } },
            scales: {
                x: { ticks: { font: { size: 11 } } },
                y: { beginAtZero: true, ticks: { font: { size: 12 } } }
            }
        };

        if (view === 'total') {
            monthChart = new Chart(mCtx, createChartConfig('line', labels, [{
                label: 'Total Articles',
                data: totalData,
                borderColor: '#2b6cb0',
                backgroundColor: 'rgba(43, 108, 176, 0.08)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointBackgroundColor: '#2b6cb0',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointHoverRadius: 7
            }], baseOpts));
        } else {
            monthChart = new Chart(mCtx, createChartConfig('bar', labels, datasets, {
                ...baseOpts,
                scales: { ...baseOpts.scales, x: { stacked: true, ...baseOpts.scales.x }, y: { stacked: true, ...baseOpts.scales.y } }
            }));
        }
    }

    // Initialize month chart
    updateMonthChart('total');
    document.getElementById('sourceFilter').addEventListener('change', e => {
        currentSourceFilter = e.target.value;
        const toggle = document.getElementById('monthViewToggle');
        toggle.value = currentSourceFilter !== 'all' ? 'stacked' : 'total';
        updateMonthChart(toggle.value);
    });
    document.getElementById('monthViewToggle').addEventListener('change', e => {
        if (e.target.value === 'total') {
            currentSourceFilter = 'all';
            document.getElementById('sourceFilter').value = 'all';
        }
        updateMonthChart(e.target.value);
    });

    function updateReadUnreadChart(view) {
        if (readUnreadChart) readUnreadChart.destroy();
        const rCtx = document.getElementById('readUnreadChart').getContext('2d');
        let data;

        if (view === 'byMonth') data = readUnreadByMonthData;
        else if (view === 'bySource') data = readUnreadBySourceData;
        else {
            const range = parseInt(document.getElementById('yearRangeSlider').value);
            data = {
                labels: readUnreadByYearData.labels.slice(0, range),
                readData: readUnreadByYearData.readData.slice(0, range),
                unreadData: readUnreadByYearData.unreadData.slice(0, range)
            };
        }

        // Scatter plot for all views
        const readScatterData = data.labels.map((label, index) => ({
            x: label,
            y: data.readData[index]
        }));
        const unreadScatterData = data.labels.map((label, index) => ({
            x: label,
            y: data.unreadData[index]
        }));

        const datasets = [
            { label: 'Read', data: readScatterData, backgroundColor: '#2b6cb0', borderColor: '#2b6cb0', borderWidth: 3, pointRadius: 6, pointHoverRadius: 8, showLine: true, fill: false, tension: 0.4 },
            { label: 'Unread', data: unreadScatterData, backgroundColor: '#fb923c', borderColor: '#fb923c', borderWidth: 3, pointRadius: 6, pointHoverRadius: 8, showLine: true, fill: false, tension: 0.4 }
        ];

        readUnreadChart = new Chart(rCtx, createChartConfig('scatter', data.labels, datasets, {
            scales: {
                x: { type: 'category', ticks: { font: { size: 11 } } },
                y: { beginAtZero: true, ticks: { font: { size: 12 } } }
            },
            plugins: { legend: { display: true, labels: { font: { size: 12 }, usePointStyle: true } } }
        }));
    }

    // Initialize read/unread chart
    updateReadUnreadChart('byYear');
    const rSlider = document.getElementById('yearRangeSlider'), rLabel = document.getElementById('yearRangeLabel');
    rSlider.max = readUnreadByYearData.labels.length;
    rSlider.value = Math.min(5, readUnreadByYearData.labels.length);
    updateLabel(rLabel, rSlider.value);
    toggleSlider(true, rSlider, rLabel);
    document.getElementById('readUnreadViewToggle').addEventListener('change', e => {
        currentReadUnreadView = e.target.value;
        toggleSlider(e.target.value === 'byYear', rSlider, rLabel);
        updateReadUnreadChart(currentReadUnreadView);
    });
    rSlider.addEventListener('input', e => {
        updateLabel(rLabel, e.target.value);
        updateReadUnreadChart('byYear');
    });

    // Initialize unread by year chart
    let unreadByYearChart = null;
    let currentUnreadYearViewMode = 'bar';
    function updateUnreadByYearChart(viewMode) {
        if (unreadByYearChart) unreadByYearChart.destroy();
        const yearRange = parseInt(document.getElementById('unreadYearChartRangeSlider').value);
        const labels = unreadByYearData.labels.slice(0, yearRange);
        const data = unreadByYearData.data.slice(0, yearRange);
        const uCtx = document.getElementById('unreadByYearChart').getContext('2d');

        const baseConfig = {
            label: 'Unread Articles',
            data,
            borderColor: '#fb923c',
            borderWidth: viewMode === 'bar' ? 1 : 3
        };

        const chartConfigs = {
            bar: {
                ...baseConfig,
                backgroundColor: '#fb923c',
                borderRadius: 8,
                type: 'bar'
            },
            line: {
                ...baseConfig,
                backgroundColor: 'rgba(249, 115, 22, 0.08)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 6,
                pointBackgroundColor: '#fb923c',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointHoverRadius: 8,
                type: 'line'
            }
        };

        const config = chartConfigs[viewMode];
        unreadByYearChart = new Chart(uCtx, createChartConfig(config.type, labels, [config], {
            plugins: { legend: { display: viewMode === 'line', labels: { font: { size: 12 }, usePointStyle: true } } },
            scales: {
                x: { ticks: { font: { size: 12 } } },
                y: { beginAtZero: true, ticks: { font: { size: 12 } } }
            }
        }));
    }

    // Initialize unread by year chart only if data has actual values
    const unreadByYearDataCondition = typeof unreadByYearData === 'object' &&
        unreadByYearData !== null &&
        Array.isArray(unreadByYearData.data) &&
        unreadByYearData.data.length > 0 &&
        unreadByYearData.data.some(value => value > 0)
    if (unreadByYearDataCondition && document.getElementById('unreadByYearChart')) {
        updateUnreadByYearChart('bar');
        const uSlider = document.getElementById('unreadYearChartRangeSlider'), uLabel = document.getElementById('unreadYearChartRangeLabel');
        uSlider.max = unreadByYearData.labels.length;
        uSlider.value = Math.min(5, unreadByYearData.labels.length);
        updateLabel(uLabel, uSlider.value);
        document.getElementById('unreadYearViewToggle').addEventListener('change', e => {
            currentUnreadYearViewMode = e.target.value;
            updateUnreadByYearChart(currentUnreadYearViewMode);
        });
        uSlider.addEventListener('input', e => {
            updateLabel(uLabel, e.target.value);
            updateUnreadByYearChart(currentUnreadYearViewMode);
        });
    } else {
        // Hide the section if there's no data
        const section = document.getElementById('unreadByYearSection');
        if (section) section.style.display = 'none';
    }

    // Initialize age distribution chart
    let ageDistributionChart = null;
    function updateAgeDistributionChart() {
        if (ageDistributionChart) ageDistributionChart.destroy();
        const aCtx = document.getElementById('ageDistributionChart').getContext('2d');
        ageDistributionChart = new Chart(aCtx, createChartConfig('pie', unreadArticleAgeDistributionData.labels, [{
            label: 'Number of Unread Articles',
            data: unreadArticleAgeDistributionData.data,
            backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 2
        }], {
            plugins: { legend: { display: true, labels: { font: { size: 12 }, usePointStyle: true } } }
        }));
    }

    // Initialize age distribution chart only if data has actual values
    const ageDistributionDataCondition = typeof unreadArticleAgeDistributionData === 'object' &&
        unreadArticleAgeDistributionData !== null &&
        Array.isArray(unreadArticleAgeDistributionData.data) &&
        unreadArticleAgeDistributionData.data.length > 0 &&
        unreadArticleAgeDistributionData.data.some(value => value > 0)
    if (ageDistributionDataCondition && document.getElementById('ageDistributionChart')) {
        updateAgeDistributionChart();
    } else {
        // Hide the section if there's no data
        const section = document.getElementById('unreadArticleAgeDistributionSection');
        if (section) section.style.display = 'none';
    }
</script>
{{end}}
{{template "base" .}}